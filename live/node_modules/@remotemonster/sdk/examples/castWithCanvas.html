<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="RemoteMonster live media service demo" />
    <meta name="author" content="Lucas Choi" />

    <title>Cast List</title>

    <!-- Custom fonts for this template-->
    <link
      href="vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet" />
    <script src="pico.js"></script>
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      ></ul>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>
            <h3 class="h3 mb-4 text-gray-800">Cast with Canvas example</h3>
          </nav>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <h4 class="font-weight-bold">What is it</h4>
            <li>This is an broadcast example after reprocessing the image obtained by getUserMedia using Canvas.</li>
            <li>In this example, we've only put text message, but you can make various changes to the stream.</li>
            <h4 class="font-weight-bold">How to use</h4>
            <li>You can create a channel or join a channel.</li>
            <li>
              To create a channel, please input a channel name and click connect
              button. And then you can make a channel with a name and other can
              find a your channel on other tab or browser.
            </li>
            <li>input any text message in message box to mix video stream and text message.</li>
            <li>
              Open the same
              <a href="./castWithCanvas.html" target="_blank">site</a> on other 
              browser <b>not other tab</b>. Then click on channel you created in the channel list.
            </li>
            <li>
              Source code:
              <a
                href="https://github.com/RemoteMonster/web-sdk/blob/master/examples/full/castWithCanvas.html"
                target="_blank"
                >github page</a
              >
            </li>
            <br />

            <!-- Content Row -->
            <div class="row">
              <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                  <!-- Card Header - Dropdown -->
                  <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                  >
                    <h6 class="m-0 font-weight-bold text-primary">Channels</h6>
                  </div>
                  <!-- Card Body -->
                  <div class="card-body">
                    <main id="lvChannel" class="text-center"></main>
                  </div>
                </div>
              </div>
              <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                  <!-- Card Header - Dropdown -->
                  <div
                    class="card-header py-3 d-flex flex-row align-items-center justify-content-between"
                  >
                    <h6 class="m-0 font-weight-bold text-primary">
                      My Channel
                    </h6>
                  </div>
                  <!-- Card Body -->
                  <div class="card-body">
                    <main class="text-center">
                      <video
                        id="localVideo"
                        class="remote-video center w-300 h-300"
                        autoplay
                        muted
                        controls
                        playsinline
                        style="position: absolute; z-index:1;background: rgba(0, 0, 0, 0.5);visibility: hidden;"
                      ></video>
                      <canvas id="myCanvas" style="width:100%"></canvas>
                      <h6
                        id="waitingTv"
                        class="m-0 font-weight-bold text-primary"
                        style="z-index:3; position: absolute;bottom: 55px;right:45px; visibility: hidden;"
                      >
                        waiting
                      </h6>
                      <input id="channelNameInput" class="form-control text-center"
                        type="text" placeholder="room name" autofocus/>
                      <a
                        id="channelBtn"
                        href="#"
                        class="btn btn-primary btn-user btn-block text-center"
                      >
                        CREATE
                      </a>
                    </main>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.container-fluid -->

          <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          />
          <!-- The webrtc adapter is required for browser compatibility -->
          <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
          <script src="/remon.js"></script>

          <script>
const channelBtnEl = document.querySelector("#channelBtn");
const channelList = document.getElementById("lvChannel");
const localVideo = document.getElementById("localVideo");
const myCanvas = document.querySelector("#myCanvas");
const inputCtx = myCanvas.getContext('2d');
inputCtx.font = '30px serif';
const channelNameInput = document.getElementById(
  "channelNameInput"
);
let localStream;
const waitingTv = document.getElementById("waitingTv");
let isConnected = false;
let isCaster = false;
let remon;
let width= 640;
let height = 480;
const key = "1234567890";
const serviceId = "SERVICEID1";
let myChannelId;
var waitingLoop;
getMediaToCanvas();
createDummyRemonForSearchLoop();
startSearchLoop();
// initPico();

// please register your own service key from remotemonster site.
const config = {
  credential: {
    key,
    serviceId
  },
  view: {
    remote: "#remoteVideo",
    local: "#localVideo",
    localStream: myCanvas.captureStream()
  }
};

const listener = {
  onConnect(chid) {
    console.log(`EVENT FIRED: onConnect: ${chid}`);
  },
  onComplete() {
    console.log("EVENT FIRED: onComplete");
    setViewsViaParameters(false, "hidden", "CLOSE", "hidden");
  },
  onDisconnectChannel() {
    // is called when other peer hang up.
    remon.close();
    isConnected = false;
    setViewsViaParameters(false, "hidden", "CREATE", "visible");
  },
  onClose() {
    // is called when remon.close() method is called.
    console.log("EVENT FIRED: onClose");
    remon.close();
    isConnected = false;
    myChannelId = "";
    setViewsViaParameters(false, "hidden", "CREATE", "visible");
  },
  onError(error) {
    console.log(`EVENT FIRED: onError: ${error}`);
  },
  onStat(result) {
    console.log(`EVENT FIRED: onStat: ${result}`);
  }
};

var update_memory= pico.instantiate_detection_memory(5);
var facefinder_classify_region = function(r, c, s, pixels, ldim) {return -1.0;};
var cascadeurl = 'https://raw.githubusercontent.com/nenadmarkus/pico/c2e81f9d23cc11d1a612fd21e4f9de0921a5d0d9/rnt/cascades/facefinder';
fetch(cascadeurl).then(function(response) {
  response.arrayBuffer().then(function(buffer) {
    var bytes = new Int8Array(buffer);
    facefinder_classify_region = pico.unpack_cascade(bytes);
    console.log('* cascade loaded');
  });
});

function rgba_to_grayscale(rgba, nrows, ncols) {
  var gray = new Uint8Array(nrows*ncols);
  for(var r=0; r<nrows; ++r)
    for(var c=0; c<ncols; ++c)
      // gray = 0.2*red + 0.7*green + 0.1*blue
      gray[r*ncols + c] = (2*rgba[r*4*ncols+4*c+0]+7*rgba[r*4*ncols+4*c+1]+1*rgba[r*4*ncols+4*c+2])/10;
  return gray;
}

function getMediaToCanvas(){
  navigator.getUserMedia({video:{width:640, height:480}, audio:true}, stream => {
    localVideo.srcObject = stream;
    drawToCanvas();
  })
}

function setViewsViaParameters(
  runWaitLoop,
  waitingTvVisibility,
  btnText,
  inputVisiblility
) {
  if (runWaitLoop) {
    waitingMsgLoop();
  } else {
    clearInterval(waitingLoop);
  }
  waitingTv.style.visibility = waitingTvVisibility;
  channelBtnEl.innerHTML = btnText;
  channelNameInput.style.visibility = inputVisiblility;
}

function start(isViewer) {
  if (isConnected) {
    isConnected = false;
    isCaster = false;
    setViewsViaParameters(false, "hidden", "CREATE", "visible");
    remon.close();
    myChannelId = "";
  } else {
    isConnected = true;
    isCaster = !isViewer;
    setViewsViaParameters(true, "visible", "CLOSE", "hidden");
    if (!isCaster) {
      config.view.remote = "#localVideo";
    }
    remon = new Remon({ config, listener });
    myChannelId = channelNameInput.value
      ? channelNameInput.value
      : getRandomId();
    channelNameInput.value = "";
    isCaster
      ? remon.createCast(myChannelId)
      : remon.joinCast(myChannelId);
  }
}

function getRandomId() {
  var text = "";
  var possible =
    "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  for (var i = 0; i < 5; i++)
    text += possible.charAt(
      Math.floor(Math.random() * possible.length)
    );
  return text;
}

channelBtnEl.addEventListener(
  "click",
  evt => {
    start(false);
    evt.preventDefault();
  },
  false
);

function createDummyRemonForSearchLoop() {
  if (remon) remon.close();
  let cfg = {
    credential: { key: key, serviceId: serviceId },
    view: { local: "#localVideo1", remote: "#remoteVideo1" },
    media: { audio: false, video: false }
  };
  remon = new Remon({ config: cfg });
}

function waitingMsgLoop() {
  var numOfPoint = 0;
  var pointStr = "";
  waitingLoop = setInterval(async function() {
    pointStr = "";
    numOfPoint++;
    if (numOfPoint === 4) numOfPoint = 0;
    for (var i = 0; i < numOfPoint; i++) {
      pointStr += ".";
    }
    waitingTv.innerText = "waiting" + pointStr;
  }, 1000);
}

function drawToCanvas() {
  inputCtx.drawImage(localVideo, 0,0, myCanvas.width, myCanvas.height);
  var rgba = inputCtx.getImageData(0, 0, 640, 480).data;
  // prepare input to `run_cascade`
  image = {
    "pixels": rgba_to_grayscale(rgba, 480, 640),
    "nrows": 480,
    "ncols": 640,
    "ldim": 640
  }
  params = {
    "shiftfactor": 0.1, // move the detection window by 10% of its size
    "minsize": 20,     // minimum size of a face
    "maxsize": 1000,    // maximum size of a face
    "scalefactor": 1.1  // for multiscale processing: resize the detection window by 10% when moving to the higher scale
  }
  // run the cascade over the frame and cluster the obtained detections
  // dets is an array that contains (r, c, s, q) quadruplets
  // (representing row, column, scale and detection score)
  dets = pico.run_cascade(image, facefinder_classify_region, params);
  dets = update_memory(dets);
  dets = pico.cluster_detections(dets, 0.2); // set IoU threshold to 0.2
  // draw detections
  for(i=0; i<dets.length; ++i)
    // check the detection score
    // if it's above the threshold, draw it
    // (the constant 50.0 is empirical: other cascades might require a different one)
    if(dets[i][3]>50.0)
    {
      inputCtx.beginPath();
      inputCtx.arc(dets[i][1], dets[i][0], dets[i][2]/2, 0, 2*Math.PI, false);
      inputCtx.lineWidth = 3;
      inputCtx.strokeStyle = 'red';
      inputCtx.stroke();
    }
  requestAnimationFrame(drawToCanvas);
}

function startSearchLoop() {
  setInterval(async function() {
    remon.config.credential.serviceId = serviceId;
    remon.config.credential.key = key;
    var searchResult = await remon.fetchCasts();
    while (channelList.firstChild) {
      channelList.removeChild(channelList.firstChild);
    }
    searchResult.forEach((ch, i) => {
      if (
        ch.status === "COMPLETE" &&
        ch.id !== myChannelId &&
        !isCaster
      ) {
        var btn = document.createElement("input");
        btn.type = "button";
        btn.name = ch.id;
        btn.value = ch.name;
        btn.className =
          "btn btn-primary btn-user btn-block text-center";
        btn.addEventListener(
          "click",
          evt => {
            channelNameInput.value = ch.id;
            start(true);
            evt.preventDefault();
          },
          false
        );

        channelList.appendChild(btn);
      }
    });
  }, 4000);
}
          </script>
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span
                >Copyright &copy;
                <a href="https://remotemonster.com">RemoteMonster</a> 2019</span
              >
            </div>
          </div>
        </footer>
        <!-- End of Footer -->
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <script>
      $(document).ready(function() {
        $("#accordionSidebar").load("nav.html");
      });
    </script>
  </body>
</html>
