<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="description" content="RemoteMonster live media service demo" />
    <meta name="author" content="Lucas Choi" />

    <title>Simple Cast</title>

    <!-- Custom fonts for this template-->
    <link
      href="vendor/fontawesome-free/css/all.min.css"
      rel="stylesheet"
      type="text/css"
    />
    <link
      href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet"
    />

    <!-- Custom styles for this template-->
    <link href="css/sb-admin-2.min.css" rel="stylesheet" />
  </head>

  <body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
      <!-- Sidebar -->
      <ul
        class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion"
        id="accordionSidebar"
      ></ul>
      <!-- End of Sidebar -->

      <!-- Content Wrapper -->
      <div id="content-wrapper" class="d-flex flex-column">
        <!-- Main Content -->
        <div id="content">
          <!-- Topbar -->
          <nav
            class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow"
          >
            <!-- Sidebar Toggle (Topbar) -->
            <button
              id="sidebarToggleTop"
              class="btn btn-link d-md-none rounded-circle mr-3"
            >
              <i class="fa fa-bars"></i>
            </button>
            <h3 class="h3 mb-4 text-gray-800">Simple Cast example</h3>
          </nav>
          <!-- End of Topbar -->

          <!-- Begin Page Content -->
          <div class="container-fluid">
            <!-- Page Heading -->
            <h4 class="font-weight-bold">How to use</h4>
            <li>Press the connect button.</li>
            <li>
              Open the same
              <a href="./simpleCast.html" target="_blank">site</a> on other tab
              or browser. If the room is created, it is automatically entered.
            </li>
            <li>
              Source code:
              <a
                href="https://github.com/RemoteMonster/web-sdk/blob/master/examples/full/simpleCast.html"
                target="_blank"
                >github page</a
              >
            </li>
            <br />

            <!-- Content Row -->
            <div class="row">
              <div class="col-xl-8 col-md-8 mb-8">
                <div class="card shadow mb-4">
                  <div class="card-body">
                    <main>
                      <div>
                        <video
                          id="localVideo"
                          class="remote-video center w-300 h-300"
                          autoplay
                          muted
                          controls
                          playsinline
                          style="z-index:1;background: rgba(0, 0, 0, 0.5); width: 100%;"
                        ></video>
                        <audio id="localAudio"
                        autoplay controls playsinline></audio><button id="audioplay" value="play">play</button>
                      </div>
                      <a
                        id="channelBtn"
                        href="#"
                        class="btn btn-primary btn-user btn-block text-center"
                      >
                        CREATE
                      </a>
                    </main>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- /.container-fluid -->

          <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
          />
          <!-- The webrtc adapter is required for browser compatibility -->
          <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
          <script src="/remon.js"></script>

          <script>
            const channelBtnEl = document.querySelector("#channelBtn");
            const audioTag= document.querySelector("#localAudio");
            const audioPlayButton = document.querySelector("#audioplay");
            const roomid= 'testchannel2';
            audioTag.play();
            audioPlayButton.addEventListener("click", ()=>{
              //audioTag.play();
              findRoom();
              
              }
              );
            let isCreated = false;
            let isCaster = false;
            // let wsurl="wss://matiz.remotemonster.com/ws";
            // let resturl = "https://matiz.remotemonster.com/rest";
            let wsurl= "wss://signal.remotemonster.com/ws";
            let resturl= "https://signal.remotemonster.com/rest";
            // let serviceId= 'healthchecker';
            // let key = 'ee1761b003084b5431bf918fa87b850bc499467bdfaf4bdf';
            // let serviceId= 'SERVICEID1';
            // let key= '1234567890';
            let serviceId= 'simpleapp';
            let key= '27f8ca5ee273153d9a9c5944c766fa097d2e16de4dda425a';
            let remon;
            // please register your own service key from remotemonster site.
            const dummyConfig = {
              credential: { key, serviceId, wsurl, resturl },
              view: {},
              media: { audio: false, video: false }
            };
            const config = {
              credential: {
                key,
                serviceId,
                wsurl,
                resturl
              },
              view: {
                remote: "#remoteVideo",
                local: "#localVideo"
              },
              media: {
                audio: true,
                video: {
                  height: 480,
                  width: 640,
                  //maxBandwidth: 300,
                }
              }
            };

            const listener = {
              onCreateChannel(chid) {
                console.log(`EVENT FIRED: onConnect: ${chid}`);
              },
              onComplete() {
                console.log("EVENT FIRED: onComplete");
                channelBtnEl.innerHTML = "CLOSE";
                audioTag.srcObject= remon.context.remoteStream;
                audioTag.play();
              },
              onDisconnectChannel() {
                // is called when other peer hang up.
                console.log("some viewer is exited");
              },
              onClose() {
                // is called when remon.close() method is called.
                console.log("EVENT FIRED: onClose");
                remon.close();
                isCreated = false;
                isCaster
                  ? (channelBtnEl.innerHTML = "CREATE")
                  : (channelBtnEl.innerHTML = "JOIN");
              },
              onError(error) {
                console.log(`EVENT FIRED: onError: ${error}`);
              },
              onStat(result) {
                console.log(`EVENT FIRED: onStat:`, result);
              },
              onReconnect() {
                console.log("onReconnect is called");
                if (!isCaster) {
                  remon.close();
                  //joinRoom(config, listener);
                }
              }
            };

            async function start() {
              if (isCreated) {
                isCreated = false;
                isCaster
                  ? (channelBtnEl.innerHTML = "CREATE")
                  : (channelBtnEl.innerHTML = "JOIN");
                remon.close();
              } else {
                isCreated = true;
                isCaster = true;
                channelBtnEl.innerHTML = "CLOSE";
                remon = new Remon({ config, listener });
                remon.createCast(roomid);
              }
            }

            async function checkForStart() {
              if (channelBtnEl.innerHTML !== "CLOSE") {
                if (!(await findRoom())) {
                  start();
                }
              } else start();
            }

            channelBtnEl.addEventListener(
              "click",
              evt => {
                checkForStart();
                evt.preventDefault();
              },
              false
            );

            async function findRoom() {
              remon = new Remon({ config: dummyConfig, listener: {} });
              var searchResult = await remon.fetchCasts();
              var isRoomExist = false;
              searchResult.forEach((ch, i) => {
                ch.type = "BROADCAST";
                if (ch.status === "COMPLETE" && ch.id === roomid) {
                  console.log(
                    "------------------- find my channel -----------------"
                  );
                  config.view.remote = "#localVideo";
                  joinRoom(config, listener);
                  return isRoomExist;
                }
              });
              return isRoomExist;
            }
            function joinRoom(config, listener) {
              remon = new Remon({ config, listener });
              remon.joinCast(roomid);
              isCaster = false;
              isCreated = true;
              isRoomExist = true;
            }
            // findRoom();
          </script>
        </div>
        <!-- End of Main Content -->

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
          <div class="container my-auto">
            <div class="copyright text-center my-auto">
              <span
                >Copyright &copy;
                <a href="https://remotemonster.com">RemoteMonster</a> 2019</span
              >
            </div>
          </div>
        </footer>
        <!-- End of Footer -->
      </div>
      <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <script>
      $(document).ready(function() {
        $("#accordionSidebar").load("nav.html");
      });
    </script>
  </body>
</html>
